name: Fix Duplicate Methods in services.tsx

on:
  workflow_dispatch:

jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Remove duplicate getPrioritizedPages methods
        run: |
          # This script finds and removes the duplicate methods
          # Keep only the first occurrence (lines 1231-1287)
          
          # Create backup
          cp src/services.tsx src/services.tsx.backup
          
          # Use awk to remove duplicate blocks
          # The correct version ends with "return [...prioritized, ...rest];"
          # followed by a closing brace
          
          awk '
          BEGIN { inside_dup = 0; dup_count = 0; keep = 1 }
          /private async getPrioritizedPages\(context: GenerationContext\): Promise<SitemapPage\[\]>/ {
            dup_count++
            if (dup_count > 1) {
              inside_dup = 1
              keep = 0
            }
          }
          /private async optimizeDOMSurgically/ {
            if (inside_dup) {
              inside_dup = 0
              keep = 1
            }
          }
          keep { print }
          ' src/services.tsx > src/services.tsx.fixed
          
          # Replace original with fixed version
          mv src/services.tsx.fixed src/services.tsx
          
      - name: Commit fix
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add src/services.tsx
          git commit -m "fix: remove duplicate getPrioritizedPages methods" || echo "No changes"
          git push
